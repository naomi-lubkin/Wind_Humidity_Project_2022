---
title: "humidity_diurnal"
author: "Larz von Huene and Naomi Lubkin"
date: "2023-09-07"
output: html_document
---

# Packaages
```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(trend)
library(patchwork)
library(kableExtra)
library(readr)
```


# Load in Data
```{r}
rh <- read_csv("Data/rh_from_humidity_analysis_rmd.csv") %>% 
  filter(year(date) >= 1941)
```


# RH diurnal analysis
```{r}
# times: 1:00 (night), 7:00 (day), 13:00 (day), 19:00 (night)

# adding in day vs. night and seasons column
rh <- rh %>% 
  mutate(tod = case_when(
           hour(date) == 1 ~ "Night",
           hour(date) == 19 ~ "Night",
           hour(date) == 7 ~ "Day",
           hour(date) == 13 ~ "Day",
           TRUE ~ NA_character_)) %>% 
  mutate(season = case_when(month(date) == 12 ~ "Winter", 
                            month(date) == 1 ~ "Winter", 
                            month(date) == 2 ~ "Winter", 
                            month(date) == 3 ~ "Spring", 
                            month(date) == 4 ~ "Spring",
                            month(date) == 5 ~ "Spring",
                            month(date) == 6 ~ "Summer",
                            month(date) == 7 ~ "Summer",
                            month(date) == 8 ~ "Summer",
                            month(date) == 9 ~ "Fall",
                            month(date) == 10 ~ "Fall",
                            month(date) == 11 ~ "Fall"))

# is there a diurnal distinction? Yes.
tod_stats <- rh %>% 
  group_by(season) %>% 
  summarize(p = t.test(RH ~ tod)[["p.value"]])

# diurnal trends graph
avg_hour <- rh %>% 
  group_by(season, year = year(date), hour = hour(date)) %>% 
  summarize(avg = mean(RH)) 
  
ggplot(avg_hour, aes(x = year, y = avg, color = as.factor(hour))) +
  geom_smooth(method = "lm", se = F) +
  #geom_point()  +
  facet_wrap(~season)

# synoptic trends plot
trends <- avg_hour %>% 
  group_by(season, hour) %>% 
  summarize(trend = sens.slope(avg, conf.level = 0.95)[["estimates"]][["Sen's slope"]],
            p = sens.slope(avg, conf.level = 0.95)[["p.value"]])
ggplot(trends, aes(x= hour, y = trend, fill = season)) +
  geom_col(position = "dodge")


avg_tod <- rh %>% 
  mutate(season = factor(season, levels = c("Winter", "Spring", "Summer", "Fall"))) %>% 
  group_by(season, year = year(date), tod) %>% 
  summarize(avg = mean(RH))  

# time of day trends plot: seasons
trends_rh <- avg_tod %>% 
  group_by(season, tod) %>% 
  summarize(trend = sens.slope(avg, conf.level = 0.95)[["estimates"]][["Sen's slope"]], 
            p = sens.slope(avg, conf.level = 0.95)[["p.value"]]) %>% 
  mutate(sig = ifelse(p <= 0.05, "Y", "N"))

rh_day_night <- ggplot(trends_rh, aes(x= tod, y = trend, fill = season)) +
  geom_col(position = "dodge", color = "black") +
  scale_fill_manual(values = c("gray", "gray", "white", "gray")) +
  labs(x = "", y = "Annual trend", title = "Relative Humidity Trends in the Day and Night", subtitle = "1941-2022", caption = "Grey indicates 95% confidence, white indicates non-significance.") +
  theme_minimal()


ggsave(filename = "Figures/rh_day_night_trends.jpeg", plot = rh_day_night, width = 8, height = 5, dpi = 300)



# Daily shifts plot
rh %>% 
  group_by(season, hour = hour(date)) %>% 
  summarize(avg = mean(RH)) %>% 
  ggplot(aes(x = hour, y = avg, color = season)) +
  geom_smooth() 

```
RH trends (to be combined with RH table in humidity_analysis.rmd)
```{r}
#seasonal
trends_rh

#annual
trends_rh_annual <- avg_tod %>% 
  group_by(tod) %>% 
  summarize(trend = sens.slope(avg, conf.level = 0.95)[["estimates"]][["Sen's slope"]], 
            p = sens.slope(avg, conf.level = 0.95)[["p.value"]]) %>% 
  mutate(sig = ifelse(p <= 0.05, "Y", "N"), season = "Annual")

#combine
trends_diurnal_rh <- rbind(trends_rh_annual, trends_rh)

# put in figures folder to combine with rh
write.csv(trends_diurnal_rh, file = "Figures/trends_diurnal_rh.csv")

```


# Fog Frequency diurnal analysis

```{r}
# creating fog data set, fog is true when RH = 100%
fog <- rh %>% 
  mutate(fog = ifelse(RH == 100, "Y", "N")) %>% 
  group_by(season, fog, tod, year = year(date)) %>% 
  summarise(n_class = n()) %>% # get number of fog and clear days
  group_by(season) %>% 
  summarise(n_season = sum(n_class), n_class = n_class, fog = fog, tod, year) %>%  # get total number of days in season
  summarise(ff = n_class/n_season, fog = fog, tod, year) %>% 
  filter(fog == "Y")

#overall plot
ggplot(fog, aes(x = year, y = ff, color = season)) +
  facet_wrap(~tod) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = F)

# something weird is happening with fall daytime trends
fog %>% 
  filter(season == "Fall", tod == "Day") %>% 
  ggplot(aes(x = year, y = ff))+
  geom_point() +
  geom_smooth(se = F)



# trend data
trends_fog <- fog %>% 
  group_by(season, tod) %>% 
  summarize(trend = sens.slope(ff, conf.level = 0.95)[["estimates"]][["Sen's slope"]], 
            p = sens.slope(ff, conf.level = 0.95)[["p.value"]]) %>% 
  mutate(sig = ifelse(p <= 0.05, "Y", "N")) 

fog_day_night <- ggplot(trends_fog, aes(x= tod, y = trend, fill = season)) +
  geom_col(position = "dodge", color = "black") +
  #scale_fill_manual(values = c("gray", "gray", "white", "gray")) +
  labs(x = "", y = "Annual trend", title = "Fog Frequency Trends in the Day and Night", subtitle = "1941-2022", caption = "Grey indicates 95% confidence, white indicates non-significance.") +
  theme_minimal()

# Summer daytime is only significant trend in ff shifts
fog %>% 
  filter(season == "Summer", tod == "Day") %>% 
  ggplot(aes(x = year, y = ff)) +
  geom_point() +
  geom_smooth(method = "lm", se = F)


```

