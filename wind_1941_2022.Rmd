---
title: "Wind Analysis: 1941-2022"
author: "Naomi Lubkin"
date: "5/1/2023"
output: html_document
---
Updated wind analysis: 1941-2022. Can now ignore wind_analysis.rmd.

#loading in libraries and data
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#libraries
library(tidyverse)
library(readr)
library(ggplot2)
library(dplyr)
library(lubridate) #to separate month, year from date data type
library(patchwork)
library(trend)
library(kableExtra)

#data
wind_2022 <- read_csv("Data/2022_wind.csv")
hourly_wind <- read_csv("Data/b16-hourly wind 1935-2021.csv")

##cleaning data

#hourly wind data, 1941-2021
#removing dates when wind observations were being switched (year of 1980) and taken in temp location (few months in 1970)
date1 <- ymd_hms("1970-05-04 00:55:00")
date2 <- ymd_hms("1970-07-09 23:55:00")

hourly_wind <- hourly_wind %>%
  na.omit() %>% 
  separate(date, into = c("date", "time"), sep = " ") %>%
  mutate(date = as.Date(date),
          month=month(date),
          year = year(date))  %>%
    mutate(year=as.numeric(year), 
         month=as.numeric(month), 
         wind_speed=as.numeric(wind_speed))

# 1941-2021
hourly_wind_41on <- hourly_wind %>%
   filter(year >= 1941)

#hourly wind data, 2022
hourly_wind_22 <- wind_2022 %>%
  na.omit() %>% 
  separate(date, into = c("date", "time"), sep = " ") %>%
  mutate(date = as.Date(date),
          month=month(date),
          year = year(date)) %>%
  dplyr::select(date, time, wind_speed, month, year) %>% #same columns as 1941 data for merge
  mutate(year=as.numeric(year), 
         month=as.numeric(month), 
         wind_speed=as.numeric(wind_speed))

#merging : dataframe with 1941-2022 hourly wind averages
hourly_wind_41_22 <- rbind(hourly_wind_41on, hourly_wind_22) 
hourly_wind_41_22 <- hourly_wind_41_22 %>%
  filter(!(date %within% interval(date1, date2))) %>% # take out dates from construction
  mutate(group =  ifelse(year(date) < 1980, 1, 
                             ifelse(year(date) > 1980, 2, NA))) # take out 1980, sort each timeframe into group 1 and 2

hourly_wind_35_22 <- rbind(hourly_wind, hourly_wind_22)


#export dataframe
write.csv(hourly_wind_41_22, file = "Data/wind_from_wind_1941_2022_rmd.csv")
```

Data frame is used in homogenization.rmd, then returned to be used here
```{r}
hourly_wind_41_22 <- read_csv("Homogenization/wind_1941_2022_homogenized.csv") %>% 
  dplyr::select(3:9,)
```

Getting averages from homogenized data
```{r}
#daily averages from hourly
daily_avg <- hourly_wind_41_22 %>%
  group_by(date) %>%
  summarize(wind_speed = mean(homogenized_wind),  #averaging hourly wind speeds by day from homogenized data
            .groups = "drop") %>%
  na.omit() %>%
  mutate(month=month(date), #adding month column
         month= as.numeric(month), #making sure month is numeric
        year = year(date),  #adding year column
         year=as.numeric(year),  #making sure year is numeric
         wind_speed=as.numeric(wind_speed)) #making sure wind speed is numeric
  
#getting monthly wind speeds from daily
monthly_avg <- daily_avg %>%
  filter(year >= 1941) %>% 
  mutate(monyear = str_c(month, "-", year)) %>%
  group_by(monyear) %>%
  summarize(wind_speed = mean(wind_speed), 
            .groups="drop") %>%
  separate(monyear, into = c("month", "year"), sep = "-") %>%
  mutate(year = as.numeric(year),
         month = as.numeric(month))

#seasonal averages 
#where "winter 1942" refers to december 1941, jan 1942, feb 1942
seasonal_avg <- daily_avg %>%
  filter(year >= 1941) %>% 
  mutate(year_for_season =  case_when(month == 12 ~ year + 1, 
                                  TRUE ~ year)) %>%
  mutate(season = case_when(month == 12 ~ "Winter", 
                            month == 1 ~ "Winter", 
                            month == 2 ~ "Winter", 
                            month == 3 ~ "Spring", 
                            month == 4 ~ "Spring",
                            month == 5 ~ "Spring",
                            month == 6 ~ "Summer",
                            month == 7 ~ "Summer",
                            month == 8 ~ "Summer",
                            month == 9 ~ "Fall",
                            month == 10 ~ "Fall",
                            month == 11 ~ "Fall")) %>%
  group_by(month, season, year) %>%
  summarise(wind_speed = mean(wind_speed), year_for_season = year_for_season) %>% # monthly avgs from daily
  group_by(season, year = year_for_season) %>% 
  summarise(wind_speed = mean(wind_speed)) # seasonal avgs from monthly
           
seasonal_avg$season <- factor(seasonal_avg$season, levels=c("Winter", "Spring", "Summer", "Fall"))

#yearly average
yearly_avg <- daily_avg %>%
  group_by(month, year) %>%
  summarise(monthly_avg_wind = mean(wind_speed)) %>% 
  group_by(year) %>%
  summarize(wind_speed = mean(monthly_avg_wind), 
            .groups="drop") %>%
  mutate(group = case_when (year <= 1940 ~ "1", 
                            year %in% 1941:1980 ~ "1", 
                            year >= 1981 ~ "2", 
                            TRUE ~ NA_character_))

t.test(wind_speed ~ group, data = hourly_wind_41_22) # averages should be different
t.test(homogenized_wind ~ group, data = hourly_wind_41_22) # averages should be similar
t.test(wind_speed ~ group, data = yearly_avg )# averages should be similar


# getting overall averages: 1941-2022
avgs <- seasonal_avg %>% 
  group_by(season) %>% 
  summarize(avg = mean(wind_speed)) %>% 
  rbind(c("Overall", mean(yearly_avg$wind_speed))) %>% 
  mutate(avg = as.numeric(avg)) %>% 
  mutate(avg = format(round(avg, 1), nsmall = 1)) %>% 
  bind_cols(seasonal_avg %>% 
              filter(year > 1980) %>% 
              group_by(season) %>% 
              summarize(avg = mean(wind_speed)) %>% 
              rbind(c("Overall", mean(yearly_avg$wind_speed))) %>% 
              mutate(avg = as.numeric(avg)) %>% 
              mutate(avg = format(round(avg, 1), nsmall = 1)))
names(avgs) <- c("Season", "Average", "Season", "Average")

wind_avgs_table <- avgs %>% 
  kbl(caption = "Wind Speed Averages (mph)") %>%
  kable_classic(full_width = F, html_font = "Cambria") %>% 
  add_header_above(c("1941-2022" = 2, "1981-2022" = 2))
save_kable(wind_avgs_table, file = "Figures/wind_avgs_table.pdf")

```

# plots
```{r}
# getting data with homogenized and not-homogenized data
yearly_avg_prehomog_homog <- hourly_wind_41_22 %>% 
  group_by(date) %>% 
  summarize(wind_speed = mean(wind_speed), 
            homogenized_wind = mean(homogenized_wind)) %>% 
  group_by(month = month(date), year = year(date)) %>% 
  summarize(wind_speed = mean(wind_speed), 
            homogenized_wind = mean(homogenized_wind)) %>% 
  group_by(year) %>% 
  summarize(wind_speed = mean(wind_speed), 
            homogenized_wind = mean(homogenized_wind))

#monthly average wind speed
year_plot_homogenized <- ggplot(data = yearly_avg_prehomog_homog, aes(x = year, y = homogenized_wind)) +
  geom_point() +
  ylim(0,45) +
  labs (x = "Year", y = "Wind Speed (mph)", title="B. Homogenized") +
 # theme_classic() +
  theme(legend.position = "none") +
  geom_vline(xintercept=1981, 
             linetype="dotted")

year_plot <- ggplot(data = yearly_avg_prehomog_homog, aes(x = year, 
                           y = wind_speed)) +
  geom_point() +
  ylim(0,45) +
  labs (x = "Year", y = "Wind Speed (mph)", title="A. Raw Data") +
  #theme_classic() +
  theme(legend.position = "none") +
  geom_vline(xintercept=1981, 
             linetype="dotted")

yearly_winds <- year_plot + year_plot_homogenized 

# export
ggsave("Figures/Wind_homogenization.jpeg", plot = yearly_winds, width = 8, height = 5, dpi = 300)


#seasonal plots 
season_homogenized_plot <- ggplot(data = seasonal_avg, aes(x = year, 
                           y = wind_speed)) +
  geom_point(aes(colour = season), show.legend = "none") +
  ylim(0,70) +
  labs (x = "Year", y = "Wind Speed (mph)", title = "Wind Speeds (Homogenized) by Season", subtitle = "1941-2022")+
  #theme_classic()+
  xlim(1941, 2022) +
  geom_vline(xintercept=1981, 
             linetype="dotted") +
  facet_wrap(~season) 

# export
ggsave("Figures/Wind_seasonal_plot.jpeg", plot = season_homogenized_plot, width = 8, height = 5, dpi = 300)
```


#sens slopes for each season 
```{r}
trends <- seasonal_avg %>% 
  group_by(season) %>% 
  summarize(trend = sens.slope(wind_speed, conf.level = 0.95)[["estimates"]], 
            p = sens.slope(wind_speed, conf.level = 0.95)[["p.value"]])

```


# Overall Plot
```{r}
# Annual wind averages 1935-2021 , with linear regression lines fitted to each period of wind observations (Figure 17 in Cronin)
# #NOTE: need to do linear regression significance tests on these lines! 
annual_avg_plot <- hourly_wind_35_22 %>%
  na.omit() %>% 
  group_by(year) %>% 
  summarize(wind_speed = mean(wind_speed)) %>% 
  mutate(group = case_when (year <= 1940 ~ "1", 
                            year %in% 1941:1980 ~ "2", 
                            year >= 1981 ~ "3", 
                            TRUE ~ NA_character_)) %>% 
  ggplot(aes (x = year, 
              y = wind_speed, 
              colour = group)) +
   geom_point (show.legend = FALSE) +
   geom_line(show.legend = FALSE)+
   geom_smooth( se =FALSE, method = 'lm', show.legend = FALSE) +
   ylim(0,50) +
   xlim(1935, 2022) +   
  theme_minimal() +
   ggtitle ("MWO Annual Wind Averages 1935-2022") +
   labs (x= "Year", y = "Wind Speed (mph)")
 
# Export
ggsave("Figures/annual_wind_averages.jpeg", plot = annual_avg_plot, width = 8, height = 5, dpi = 300)
```

# Trend table
```{r}
# 1981 - 2022
#annual
annual_trend_81 <- yearly_avg %>% 
  filter(year >= 1981) %>% 
  summarize(season = "Annual",
            annual_trend = sens.slope(wind_speed, conf.level = 0.95)[["estimates"]],
            p = sens.slope(wind_speed, conf.level = 0.95)[["p.value"]]) 


seasonal_trends_81 <- seasonal_avg %>% 
  filter(year >=1981) %>%  
  group_by(season) %>% 
  summarize(annual_trend = sens.slope(wind_speed, conf.level = 0.95)[["estimates"]],
            p = sens.slope(wind_speed, conf.level = 0.95)[["p.value"]])


trends_all_81 <- rbind(annual_trend_81, seasonal_trends_81) %>% 
  mutate(decadal_trend = annual_trend*10,
         " " = ifelse(is.na(season), "Annual", season), 
         decadal_trend = format(round(decadal_trend, 3), nsmall = 3), # round trend to 3 decimal places
         "Decadal trend (mph/decaade)" = ifelse(p <= 0.05, str_c(decadal_trend, "*"), decadal_trend), # add asterisks
         "p-value" = p) %>% 
  dplyr::select(" ", "Decadal trend (mph/decaade)")


wind_table_81 <- trends_all_81 %>% 
  kbl(caption = "Decadal Trends of Wind Speeds from 1981-2022") %>%
  footnote(general = c("*indicates 95% confidence", "Sen's Slope analysis used to calculate annual wind speed trends")) %>%   kable_classic(full_width = F, html_font = "Cambria")  

save_kable(wind_table_81, file = "Figures/wind_table_81.pdf")

# 1941 - 2022 homogenized
#annual
annual_trend_41 <- yearly_avg %>%
  summarize(season = "Annual",
            annual_trend = sens.slope(wind_speed, conf.level = 0.95)[["estimates"]],
            p = sens.slope(wind_speed, conf.level = 0.95)[["p.value"]])


seasonal_trends_41 <- seasonal_avg %>%
  group_by(season) %>%
  summarize(annual_trend = sens.slope(wind_speed, conf.level = 0.95)[["estimates"]],
            p = sens.slope(wind_speed, conf.level = 0.95)[["p.value"]])


trends_all_41 <- rbind(annual_trend_41, seasonal_trends_41) %>%
  transmute(decadal_trend = annual_trend*10,
         " " = ifelse(is.na(season), "Annual", season),
         decadal_trend = format(round(decadal_trend, 3), nsmall = 3), # round trend to 3 decimal places
         "Decadal trend (mph/decaade)" = ifelse(p <= 0.05, str_c(decadal_trend, "*"), decadal_trend), # add asterisks
         "p-value" = p) %>%
  dplyr::select(" ", "Decadal trend (mph/decaade)")


wind_table_41 <- trends_all_41 %>%
  kbl(caption = "Decadal Trends of Wind Speeds from 1941-2022") %>%
  footnote(general = c("*indicates 95% confidence", "Sen's Slope analysis used to calculate annual wind speed trends", "Wind speeds prior to 1981 homogenized to account for the Observatory location shift")) %>%   kable_classic(full_width = F, html_font = "Cambria")

save_kable(wind_table_41, file = "Figures/wind_table_1941.pdf")

```



