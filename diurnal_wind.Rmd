---
title: "Winter Diurnal Wind Analysis"
author: "Naomi Lubkin"
date: "2023-08-22"
output: html_document
---
Diurnal wind speed and direction analysis for winter months (DJF), to compare winds between day and night. 
Cutoff between day and night: day is 6am-6pm, night is 6pm-6am
Data from 1941-2022

Wind direction code is not working right now, do not need to continue on with diurnal wind direction analysis.
#loading in packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

#loading in and cleaning data 
```{r}
#data
hourly_wind <- read_csv("Homogenization/wind_1941_2022_homogenized.csv")

hourly_direction <- read_csv("Data/b16-hourly wind speed plus direction 1935-2021.csv")
wind_2022_dir <- read_csv("Data/2022_wind.csv") %>%
  select(date, wind_speed, wind_direction) %>% 
  rbind(hourly_direction)


#wind speed: winter 1941-2022, day vs. night
speed <- hourly_wind %>%
  mutate(wind_speed = as.numeric(wind_speed)) %>%
  na.omit() %>%
  mutate(time = hour(time) + 1) %>% # rounding the hour
  mutate(day_status = case_when (time >= 1 & time<=6 ~"night", 
                                 time >6 & time<=18 ~"day", 
                                 time > 18 ~ "night")) %>%
   mutate(month = month(date), 
         year = year(date)) %>%
   mutate(season = case_when(month == 12 ~ "Winter", 
                            month == 1 ~ "Winter", 
                            month == 2 ~ "Winter", 
                            month == 3 ~ "Spring", 
                            month == 4 ~ "Spring",
                            month == 5 ~ "Spring",
                            month == 6 ~ "Summer",
                            month == 7 ~ "Summer",
                            month == 8 ~ "Summer",
                            month == 9 ~ "Fall",
                            month == 10 ~ "Fall",
                            month == 11 ~ "Fall")) 
  

#wind direction: winter 1941-2022, day vs. night
direction <- hourly_direction %>%
 mutate(simple_direction =  case_when( wind_direction == "WSW" ~ "SW", 
                                        wind_direction == "WNW" ~ "NW", 
                                        wind_direction == "NNW" ~ "NW",
                                        wind_direction == "NNE" ~ "NE",
                                        wind_direction == "ENE" ~ "NE",
                                        wind_direction == "ESE" ~ "SE",
                                        wind_direction == "SSE" ~ "SE",
                                        wind_direction == "SSW" ~ "SW", 
                                        wind_direction == "N" ~ "N",
                                        wind_direction == "NE" ~ "NE",
                                        wind_direction == "E" ~ "E",
                                        wind_direction == "SE" ~ "SE",
                                        wind_direction == "S" ~ "S",
                                        wind_direction == "SW" ~ "SW",
                                        wind_direction == "W" ~ "W",
                                        wind_direction == "NW" ~ "NW", 
                                        wind_direction == "00" ~ NA, 
                                        wind_direction == "V" ~ NA)) %>%
    mutate(dir_degree = case_when(simple_direction == "N" ~ 0,
                         simple_direction == "NE" ~ 45,
                         simple_direction == "E" ~ 90,
                         simple_direction == "SE" ~ 135,
                         simple_direction == "S" ~ 180,
                         simple_direction == "SW" ~ 225,
                         simple_direction == "W" ~ 270,
                         simple_direction == "NW" ~ 315)) %>%
  rename(dir_compass = simple_direction) %>%
  select(date, dir_compass, dir_degree, wind_speed, era) %>%
  mutate(year = year(date), 
         month = month(date)) %>%
  filter(year >= 1941) %>%
  na.omit() %>%
  mutate(time = hour(date) + 1) %>%
  mutate(day_status = case_when (time >= 1 & time<=6 ~"night", 
                                 time >6 & time<=18 ~"day", 
                                 time > 18 ~ "night")) %>%
  filter(month == 12 | month == 1 | month== 2)




#counts and proportions for wind direction
wind_counts <- direction %>%
  group_by(dir_compass, year, day_status) %>%
  summarise(diryear_count=n(),
            .groups = 'drop') %>%
  group_by(year) %>%
  mutate(yeartotal_count = sum(diryear_count),
         prop = (diryear_count/yeartotal_count))

```

# getting speed averages
```{r}
speed_season <- speed %>% 
  group_by(season, date, day_status) %>% 
  summarize(wind_speed = mean(homogenized_wind)) %>% 
  group_by(season, month = month(date), year =year(date), day_status) %>% 
  summarize(wind_speed = mean(wind_speed)) %>% 
  group_by(season, year, day_status) %>% 
  summarize(wind_speed = mean(wind_speed))

speed_year <- speed %>%
  group_by(date, day_status) %>% 
  summarize(wind_speed = mean(homogenized_wind)) %>% 
  group_by(month = month(date), year =year(date), day_status) %>% 
  summarize(wind_speed = mean(wind_speed)) %>% 
  group_by(year, day_status) %>% 
  summarize(wind_speed = mean(wind_speed))
```


#Wind speed analysis
```{r}
#stats
#t-test between day and night, annual
t <- t.test(homogenized_wind ~ day_status, data = speed, var.equal=TRUE)

# Difference between day and night speeds, and trends of the differences
diff(unname(t$estimate[1:2]))

t_trends <- speed %>% 
  group_by(year,season) %>% 
  summarize(diff = diff(t.test(homogenized_wind ~ day_status, var.equal=TRUE)[["estimate"]])) 
ggplot(t_trends, aes(x = year, y = diff))+
  geom_point()+
  geom_smooth(method = "lm", se = F) +
  facet_wrap(~season)

t_trends %>% 
  group_by(season) %>% 
 summarize(p = sens.slope(diff, conf.level = 0.95)[["p.value"]])
  
#seasonal t-test
speed %>% 
  group_by(season) %>% 
  summarize(diff = diff(t.test(homogenized_wind ~ day_status, var.equal=TRUE)[["estimate"]]),
    p = t.test(homogenized_wind ~ day_status, var.equal=TRUE)[["p.value"]])


#plot: seasonal day & night 
wind_diurnal_season <- ggplot(data = speed_season, aes(x=year, y = wind_speed, color = day_status)) +
  geom_smooth(se = F)+
  facet_wrap(~season) + 
  theme_classic() +
  labs(title = "Seasonal Diurnal Average Wind Speeds", subtitle = "1941-2022", x = "Year", y = "Wind Speed (mph)") +
  scale_color_discrete(name = "Day Status")

ggsave(wind_diurnal_season, file = "Figures/wind_diurnal_season.jpeg", width = 8, height = 5, dpi = 800)
# trends

seasonal_trends <- speed_season %>% 
  group_by(season, day_status) %>% 
  summarize(trend = sens.slope(wind_speed, conf.level = 0.95)[["estimates"]][["Sen's slope"]],
            p = sens.slope(wind_speed, conf.level = 0.95)[["p.value"]]) 
trends <- speed_year %>% 
          group_by(day_status) %>% 
          summarize(trend = sens.slope(wind_speed, conf.level = 0.95)[["estimates"]][["Sen's slope"]],
            p = sens.slope(wind_speed, conf.level = 0.95)[["p.value"]]) %>% 
  mutate(season = "Annual") %>% 
  rbind(seasonal_trends) 

# export for trends table
write.csv(trends, file = "Figures/diurnal_wind_trends.csv")

```

#Wind direction analysis
```{r}
t.test(prop ~ day_status, data = wind_counts)

ggplot(data = wind_counts, aes(x=year, y = prop)) +
  geom_bar(stat="identity", position = "dodge") +
  facet_wrap(day_status~dir_compass, nrow=8, ncol=2)

```

