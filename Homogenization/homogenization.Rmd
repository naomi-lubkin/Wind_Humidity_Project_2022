---
title: "Homogenization"
author: "Naomi Lubkin"
date: '2022-07-18'
output: html_document
---
Attempt at homogenization of 1940-2021 MWO wind speed data. Initial attempts include using climatol and snht, but eventually we opt to find the bootstrapped averages due to the fact that (1) we know the date of the shift in station relocataion and (2) the wind speed data is not on a normal curve.

```{r setup, include=FALSE, echo=F}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(climatol)
library(snht)
library(here)
library(lubridate)
library(boot)
```

#Loading in data/making dataframes
```{r}
#for monthly data (doesn't include 2022)
#b16 monthly average wind speed (from hourly averages), jan 1935- dec 2021
#monthly_avg <- read_csv("b16-hourly monthly wind average 1935-2021.csv")
#
# #cleaning data 
# monthly_avg <- monthly_avg %>%
#   mutate(monthly_avg_speed = as.numeric(monthly_avg_speed), 
#          monthly_avg_spd = round(monthly_avg_speed, digits = 1), 
#          date = as.Date(date), 
#          month = month(date), 
#          year =year(date)) 
# 
# wind_spd <- monthly_avg %>%
#   filter(year>=1941) %>% 
#   dplyr::select(monthly_avg_spd) %>% 
#   rename(wind = monthly_avg_spd)

#for hourly data
hourly_avg <- read_csv("/Users/larzvonhuene/Documents/GitHub/Wind_Humidity_Project_2022/Data/wind_from_wind_1941_2022_rmd.csv")
hourly_avg <- hourly_avg %>%
  mutate(wind_speed = as.numeric(wind_speed)) %>%
  filter(year(date)>=1941) %>% 
  dplyr::select(date, wind_speed)
  

# #daily averages (doesn't include 2022)
# daily_avg <- read_csv("/Users/larzvonhuene/Documents/GitHub/Wind_Humidity_Project_2022/Data/b16-hourly daily wind average 1935-2021.csv")
# daily_avg<- daily_avg %>%
#   mutate(wind_speed = as.numeric(daily_avg_speed)) %>%
#   filter(year(date)>=1941)
```


```{r}
#saving wind data as txt file
write.table(wind_spd, file = "wind_1941-2021.dat", col.names=FALSE, row.names = FALSE)

#making txt file of station information 
X <- c(44.27,44.270833)
Y <- c(71.303611, 71.303333)
Z <- c(1920.85, 1925.422)
CODE <- c(0, 0)
NAME <- c("OBS", "SATOWER")
df <- data.frame(X, Y, Z, CODE, NAME)
write.table(df, file = 'wind_1941-2021.est', sep=" ", col.names = FALSE, row.names = FALSE)

homogen("wind", 1941, 2021, nm = 12, std = 2)
```


```{r}
#SNHT with monthly averages
#period is months before aug 1981
wind_snht_monthly<- snht(wind_spd$wind, period=476, robust=FALSE, time =NULL)
summary(wind_snht_monthly)
snht_plot <- plotSNHT(wind_spd$wind, wind_snht_monthly, time = NULL, alpha = 0.05)

#SNHT with hourly averages 
#period is hours before aug 1 1981
#gets the error: Period is too large to compute statistics
wind_snht_hourly <- snht(hourly_avg$wind_speed, period = 355729, robust = FALSE, time = NULL)
hist(hourly_avg$wind_speed)

#SNHT with daily averages
#period is days before aug 1 1981
wind_snht_daily <- snht(daily_avg$wind_speed, period = 14609, robust = FALSE, time = NULL)
summary(wind_snht_daily)
snht_plot_daily <- plotSNHT(daily_avg$wind_speed, wind_snht_daily, time=NULL, alpha = 0.05)
```

```{r}
#Transforming data with square root
daily_avg_transformed <- daily_avg %>% 
  mutate(wind_speed_transformed = wind_speed^(1/1.7)) %>%  #square root transformation
  na.omit() %>% 
  group_by(date(date)) %>% 
  summarize(avg_daily_transformed = mean(wind_speed_transformed))

hist(daily_avg_transformed$avg_daily_transformed)

#period is before June 1, 1980
summary(snht(daily_avg_transformed$avg_daily_transformed, period = 14381))

```


## NEW TACTIC: bootstrap to find averages, then homogenize
```{r}
# making datasets
hourly_avg_1941 <- hourly_avg %>% 
  filter(year(date) < 1980) %>% 
  na.omit()
hourly_avg_1981 <- hourly_avg %>% 
  filter(year(date) > 1980) %>% 
  na.omit()

# function for bootstrapping
means <- function(d, i) {
  d2 <- d[i,]
  return(mean(d2$wind_speed)) 
}

# boot averages: 1941 - 1980
reps_41 <- boot(hourly_avg_1941, means, R = 100)
plot(reps_41)

# boot averages: 1981 - 2022
reps_81 <- boot(hourly_avg_1981, means, R = 100)
plot(reps_81)

# ratio
reps_81$t0/reps_41$t0


# homogenize and recombine 
hourly_avg_1941 <- hourly_avg_1941 %>% 
  mutate(homogenized_wind = wind_speed * 1.056282) # homogenize by multiplying first era by 1.05
hourly_avg_1981 <- hourly_avg_1981 %>% 
  mutate(homogenized_wind = wind_speed)
homogenized <- rbind(hourly_avg_1941, hourly_avg_1981)


# exporting homogenized data
write.csv(homogenized, file = "wind_1941_2022_homogenized.csv")
  
```


## Bootstrap the difference in means
```{r}
# bootstrap the difference in means between time periods
hourly_avg_h <- hourly_avg %>% 
  mutate(series = ifelse(year(date) < 1980, 1, 2),
         series = factor(series)) %>% 
  na.omit() %>% 
  dplyr::select(wind_speed, series) 

diff.means <- function(d, f)
{    n <- nrow(d)
     gp1 <- 1:table(as.numeric(d$series))[1]
     m1 <- sum(d[gp1,1] * f[gp1])/sum(f[gp1])
     m2 <- sum(d[-gp1,1] * f[-gp1])/sum(f[-gp1])
     ss1 <- sum(d[gp1,1]^2 * f[gp1]) - (m1 *  m1 * sum(f[gp1]))
     ss2 <- sum(d[-gp1,1]^2 * f[-gp1]) - (m2 *  m2 * sum(f[-gp1]))
     c(m1 - m2, (ss1 + ss2)/(sum(f) - 2))
}
diff_means <- boot(hourly_avg_h, diff.means, R = 100, stype = "f", strata = as.vector(hourly_avg_h$series))
plot(diff_means)

# checking against the averages from above
reps_41$t0 - diff_means$t0[1] # mean from 41-80 period minus the difference in means
reps_81$t0 # mean from 81-22 period
```


