---
title: "Homogenization"
author: "Naomi Lubkin"
date: '2022-07-18'
output: html_document
---
Attempt at homogenization of 1940-2021 MWO wind speed data. Initial attempts include using climatol and snht, but eventually we opt to find the bootstrapped averages due to the fact that (1) we know the date of the shift in station relocataion and (2) the wind speed data is not on a normal curve. Data is split into 1941-1980 and 1981-2022 timeframes (excludes data from 1980). 

```{r setup, include=FALSE, echo=F}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(climatol)
library(snht)
library(here)
library(lubridate)
library(boot)
```

#Loading in data/making dataframes
```{r}
#for monthly data (doesn't include 2022)
#b16 monthly average wind speed (from hourly averages), jan 1935- dec 2021
#monthly_avg <- read_csv("b16-hourly monthly wind average 1935-2021.csv")
#
# #cleaning data 
# monthly_avg <- monthly_avg %>%
#   mutate(monthly_avg_speed = as.numeric(monthly_avg_speed), 
#          monthly_avg_spd = round(monthly_avg_speed, digits = 1), 
#          date = as.Date(date), 
#          month = month(date), 
#          year =year(date)) 
# 
# wind_spd <- monthly_avg %>%
#   filter(year>=1941) %>% 
#   dplyr::select(monthly_avg_spd) %>% 
#   rename(wind = monthly_avg_spd)

#for hourly data
hourly_avg <- read_csv("/Users/larzvonhuene/Documents/GitHub/Wind_Humidity_Project_2022/Data/wind_from_wind_1941_2022_rmd.csv")
hourly_avg <- hourly_avg %>%
  mutate(wind_speed = as.numeric(wind_speed)) %>%
  filter(year(date)>=1941) 

# #daily averages (doesn't include 2022)
# daily_avg <- read_csv("/Users/larzvonhuene/Documents/GitHub/Wind_Humidity_Project_2022/Data/b16-hourly daily wind average 1935-2021.csv")
# daily_avg<- daily_avg %>%
#   mutate(wind_speed = as.numeric(daily_avg_speed)) %>%
#   filter(year(date)>=1941)
```

## Bootstrap to find averages, then homogenize
```{r}
# making datasets
hourly_avg_1941 <- hourly_avg %>% 
  filter(year(date) < 1980) %>% 
  na.omit()
hourly_avg_1981 <- hourly_avg %>% 
  filter(year(date) > 1980) %>% 
  na.omit()

# function for bootstrapping
means <- function(d, i) {
  d2 <- d[i,]
  return(mean(d2$wind_speed)) 
}

# boot averages: 1941 - 1980
reps_41 <- boot(hourly_avg_1941, means, R = 100)
plot(reps_41)

# boot averages: 1981 - 2022
reps_81 <- boot(hourly_avg_1981, means, R = 100)
plot(reps_81)

# ratio
reps_81$t0/reps_41$t0


# homogenize and recombine 
hourly_avg_1941 <- hourly_avg_1941 %>% 
  mutate(homogenized_wind = wind_speed * 1.056) # homogenize by multiplying first era by 1.05
hourly_avg_1981 <- hourly_avg_1981 %>% 
  mutate(homogenized_wind = wind_speed)
homogenized <- rbind(hourly_avg_1941, hourly_avg_1981)


# exporting homogenized data
write.csv(homogenized, file = "wind_1941_2022_homogenized.csv")
  
```


## Bootstrap the difference in means
```{r}
# bootstrap the difference in means between time periods
hourly_avg_h <- hourly_avg %>% 
  mutate(series = ifelse(year(date) < 1980, 1, 2),
         series = factor(series)) %>% 
  na.omit() %>% 
  dplyr::select(wind_speed, series) 

diff.means <- function(d, f)
{    n <- nrow(d)
     gp1 <- 1:table(as.numeric(d$series))[1]
     m1 <- sum(d[gp1,1] * f[gp1])/sum(f[gp1])
     m2 <- sum(d[-gp1,1] * f[-gp1])/sum(f[-gp1])
     ss1 <- sum(d[gp1,1]^2 * f[gp1]) - (m1 *  m1 * sum(f[gp1]))
     ss2 <- sum(d[-gp1,1]^2 * f[-gp1]) - (m2 *  m2 * sum(f[-gp1]))
     c(m1 - m2, (ss1 + ss2)/(sum(f) - 2))
}
diff_means <- boot(hourly_avg_h, diff.means, R = 100, stype = "f", strata = as.vector(hourly_avg_h$series))
plot(diff_means)

# checking against the averages from above
reps_41$t0 - diff_means$t0[1] # mean from 41-80 period minus the difference in means
reps_81$t0 # mean from 81-22 period
```
