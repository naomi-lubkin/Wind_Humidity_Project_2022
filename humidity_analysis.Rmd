---
title: "Relative Humidity"
author: "Larz von Huene"
date: '2022-06-06'
output: html_document
---

# Packages and set working directory
```{r}
library(tidyverse)
library(psychrolib)
library(lubridate)

knitr::opts_chunk$set(echo = TRUE)
setwd("//wdc-fileserver/Staff/Summit/Interns/Naomi Lubkin/Wind and Humidity Climate Trends")
```

# Load in Data
```{r, show_col_types = FALSE}
synoptic <- read_csv("//wdc-fileserver/Staff/Summit/Interns/Naomi Lubkin/Wind and Humidity Climate Trends/Data/b16 synoptic data 1935-2021.csv")
```
# Clean data
```{r}
synoptic <- synoptic %>% 
  filter(wet_bulb != "NULL" &  pressure_mb != "NULL") %>%  # removes all null values (from wet_bulb, dry_bulb, and pressure_mb)
  mutate(dry_bulb = as.numeric(dry_bulb), 
         wet_bulb = as.numeric(wet_bulb), 
         pressure_mb = as.numeric(pressure_mb), 
         precipitation = as.numeric(precipitation)) %>% # switch from chr to dbl
  filter(wet_bulb <= dry_bulb) # ensures that wet bulb is less than or equal to dry bulb for the sake of the RH equation

```


# Calculate Relative Humidity 
```{r}
SetUnitSystem("IP") #sets units to farenheit
synoptic_rh <- synoptic %>% 
  mutate(RH = GetRelHumFromTWetBulb(synoptic$dry_bulb, synoptic$wet_bulb, synoptic$pressure_mb)) %>% # from psychrolib package, get RH
  mutate(year = year(date), month = month(date)) %>% # get month and year
  mutate(dry_bulb_C = (dry_bulb-32)/1, wet_bulb_C = (wet_bulb-32)/1.8)
  




# Calculations from WMO annex 4.B
# split data into ice and water (based on Seidel's distinction)
synoptic_rh_liquid <- synoptic_rh %>% 
  filter(wet_bulb_C >= 0) 
synoptic_rh_ice <- synoptic_rh %>% 
  filter(wet_bulb_C < 0)


# saturation vapor pressure
f_p_ice <- 1.0016+3.15*(10^-6)*(synoptic_rh_ice$pressure_mb)-0.074*(synoptic_rh_ice$pressure_mb)^-1 # function of pressure
f_p_water <- 1.0016+3.15*(10^-6)*(synoptic_rh_liquid$pressure_mb)-0.074*(synoptic_rh_liquid$pressure_mb)^-1

sat_vap_p_water_pure <- 6.112^(17.62*(synoptic_rh_liquid$dry_bulb_C)/(243.12+(synoptic_rh_liquid$dry_bulb_C))) # saturation vapor pressure for pure water
sat_vap_p_water_moist <- f_p_water*sat_vap_p_water_pure  # saturation vapor pressure for moist water
  
sat_vap_p_ice_pure <- 6.112^(22.46*(synoptic_rh_ice$dry_bulb_C)/(272.62+(synoptic_rh_ice$dry_bulb_C)))  # saturation vapor pressure for pure ice
sat_vap_p_ice_moist <- f_p_ice*sat_vap_p_ice_pure  # saturation vapor pressure for moist ice?

# Dew point and Frost point


# psychometric formulas for the Assmann psychrometer
water_vap_p <- (6.112^(17.62*(synoptic_rh_liquid$wet_bulb_C)/(243.12+(synoptic_rh_liquid$wet_bulb_C))))*f_p_water - 6.53*(10^-4)*(1+0.000944*(synoptic_rh_liquid$wet_bulb_C))*(synoptic_rh_liquid$pressure_mb)*(synoptic_rh_liquid$dry_bulb_C - synoptic_rh_liquid$wet_bulb_C)

# Relative humidity
rh <- 100*water_vap_p/sat_vap_p_water_moist

synoptic_rh_liquid <- synoptic_rh_liquid %>% 
  mutate(RH_calc = rh)


```


# separate by seasons
```{r}
# seasons by month for ease: so winter is 12 and 1-2, spring is 3-5, summer is 6-8, fall is 9-11
synoptic_rh <- synoptic_rh %>% 
  mutate(season = ifelse(between(month, 1, 2), "winter",
                         ifelse(month == 12, "winter", 
                                ifelse(between(month, 3, 5), "spring",
                                       ifelse(between(month, 6, 8), "summer",
                                              ifelse(between(month, 9, 11), "fall", NA))))))

season_rh <- synoptic_rh %>% 
  group_by(season, year) %>% 
  summarize(average_RH = mean(RH))
```

# Seasonal comparisons
```{r}
## Visual
season_rh %>% 
  ggplot(aes(year, average_RH, color = season)) +
  geom_point() +
  geom_smooth(method = lm) +
  facet_wrap(~season)


## Linear regression of seasonal data for all season 1935 - 2021, using seasonal averages

# fall
fall_rh <- season_rh %>% 
  filter(season == "fall") # isolate fall data

fall.lm = lm(average_RH ~ year, data = fall_rh)
summary(fall.lm)
# p-value  = 0.127
# adjusted r-squared = 0.01574


# spring
spring_rh <- season_rh %>% 
  filter(season == "spring") # isolate spring data

spring.lm = lm(average_RH ~ year, data = spring_rh)
summary(spring.lm)
# p-value  = 0.1129
# adjusted r-squared = 0.01789

# summer
summer_rh <- season_rh %>% 
  filter(season == "summer") # isolate summer data

summer.lm = lm(average_RH ~ year, data = summer_rh)
summary(summer.lm)
# p-value  = 0.02197
# adjusted r-squared = 0.04916

# winter
winter_rh <- season_rh %>% 
  filter(season == "winter") # isolate winter data

winter.lm = lm(average_RH ~ year, data = winter_rh)
summary(winter.lm)
# p-value  = 0.3717
# adjusted r-squared = -0.002254 

```

# Monthly comparisons, focusing on November 
```{r}
month_rh <- synoptic_rh %>% 
  group_by(month, year) %>% 
  summarize(average_RH = mean(RH))

# overview of all months
ggplot(month_rh, aes(year, average_RH)) + geom_point() + geom_smooth(method = lm) + facet_wrap(~month)

# November
month_rh %>% 
  filter(month == 11) %>% 
  ggplot(aes(year, average_RH)) + geom_point() + geom_smooth(method = lm)


```

